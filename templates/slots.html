{% extends "base.html" %}

{% block title %}{{ nome }}{% endblock %}

{% block content %}
<h1>{{ nome }}</h1>
<div id='calendar'></div>

<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');

    const slotSet = {{ slot_settimanali | tojson }};
    const utenteAutenticato = {{ utente_autenticato | tojson }};

    const slotsByDay = {};
    slotSet.forEach(slot => {
      if (!slotsByDay[slot.giorno]) {
        slotsByDay[slot.giorno] = [];
      }
      slotsByDay[slot.giorno].push({
        ora: slot.ora,
        coach: slot.coach,
        stato: slot.stato
      });
    });

    const weekdayMap = {
      "Lunedì": 1,
      "Martedì": 2,
      "Mercoledì": 3,
      "Giovedì": 4,
      "Venerdì": 5,
      "Sabato": 6,
      "Domenica": 0
    };

    const events = [];

    for (let giorno in slotsByDay) {
      let dow = weekdayMap[giorno];
      slotsByDay[giorno].forEach(slot => {
        const isPrenotato = slot.stato === 'prenotato';
        events.push({
          title: isPrenotato ? 'Occupato' : slot.coach,
          startTime: slot.ora,
          endTime: `${String(parseInt(slot.ora.slice(0, 2)) + 1).padStart(2, '0')}:00`,
          daysOfWeek: [dow],
          backgroundColor: isPrenotato ? '#dc3545' : '#28a745',
          borderColor: isPrenotato ? '#a71d2a' : '#1e7e34',
          display: 'auto',
        });
      });
    }

    const calendar = new FullCalendar.Calendar(calendarEl, {
      locale: 'it',
      initialView: 'timeGridWeek',
      firstDay: 1,
      slotMinTime: "08:00:00",
      slotMaxTime: "21:00:00",
      allDaySlot: false,
      events: events,
      selectable: true,
      select: function(info) {
        const giornoSettimana = info.start.toLocaleDateString('it-IT', { weekday: 'long' });
        const giorno = giornoSettimana.charAt(0).toUpperCase() + giornoSettimana.slice(1);
        const ora = info.start.toTimeString().slice(0, 5);

        const occupato = events.some(ev =>
          ev.daysOfWeek.includes(info.start.getDay()) &&
          ev.startTime === ora &&
          ev.title === "Occupato"
        );

        if (occupato) {
          alert("Questo slot è già prenotato.");
          return;
        }

        if (!utenteAutenticato) {
          alert("Devi accedere alla tua area personale per prenotare uno slot.");
          return;
        }

        const conferma = confirm(`Vuoi prenotare lo slot ${giorno} alle ${ora}?`);
        if (conferma) {
          console.log("Prenotazione inviata:", {
            servizio: "{{ servizio }}",
            giorno: giorno,
            ora: ora
          });
          fetch('/prenota_slot', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              servizio: "{{ servizio }}",
              giorno: giorno,
              ora: ora
            })
          }).then(resp => {
            if (resp.status === 200) {
              alert("Prenotazione effettuata con successo!");
              location.reload();
            } else if (resp.status === 409) {
              alert("Questo slot è già stato prenotato.");
            } else {
              alert("Errore durante la prenotazione.");
            }
          });
        }
      }
    });

    calendar.render();
  });
</script>
{% endblock %}
